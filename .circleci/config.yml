# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
jobs:
  test:
    # Use a machine executor because it most easily supports multiple languages
    machine:
      # See https://circleci.com/docs/2.0/configuration-reference/#machine for the list of images
      image: ubuntu-1604:202004-01
    steps:
      - checkout
      # Install bazelisk. See https://github.com/bazelbuild/bazelisk#requirements
      - run: go get github.com/bazelbuild/bazelisk
      - run: bazelisk test --test_output=errors //...
  check-buildifier:
    docker:
      # See https://circleci.com/docs/2.0/docker-image-tags.json for a list of images
      - image: circleci/node:14.9.0@sha256:8ccaad2ddfde03bb3a16e5210ce69372e2a2df9858a4f0ebfc707b657332b2e6
    steps:
      - checkout
      - run: yarn install --frozen-lockfile --non-interactive
      - run: .circleci/check_buildifier
      - run:
          command: echo "Run .circleci/fix_buildifier"
          when: on_fail
  check-typescript:
    docker:
      # See https://circleci.com/docs/2.0/docker-image-tags.json for a list of images
      - image: circleci/node:14.9.0@sha256:8ccaad2ddfde03bb3a16e5210ce69372e2a2df9858a4f0ebfc707b657332b2e6
    steps:
      - checkout
      - run: yarn install --frozen-lockfile --non-interactive
      - run: .circleci/check_typescript
      - run:
          command: echo "Run .circleci/fix_typescript"
          when: on_fail
  check-json:
    docker:
      # See https://circleci.com/docs/2.0/docker-image-tags.json for a list of images
      - image: circleci/python:3.8.5@sha256:885c613a51b79d8343d2122f6f564c9c196e9f8ba315e75b0e93b62c068f74f3
    steps:
      - checkout
      - run: .circleci/check_json
      - run:
          command: echo "Run .circleci/fix_json"
          when: on_fail
  check-cc:
    docker:
      # See https://circleci.com/docs/2.0/docker-image-tags.json for a list of images
      - image: circleci/node:14.9.0@sha256:8ccaad2ddfde03bb3a16e5210ce69372e2a2df9858a4f0ebfc707b657332b2e6
    steps:
      - checkout
      - run: yarn install --frozen-lockfile --non-interactive
      - run: |
          find . -name *.h -o -name *.cc | xargs yarn clang-format --Werror -n -style="{BasedOnStyle: Google, Language: Cpp}"
      - run:
          command: |
            echo "Run find . -name *.h -o -name *.cc | xargs yarn clang-format -i -style=\"{BasedOnStyle: Google, Language: Cpp}\""
          when: on_fail
  check-java:
    docker:
      # See https://circleci.com/docs/2.0/docker-image-tags.json for a list of images
      - image: circleci/openjdk:14.0.2-buster@sha256:fd3a1a3b49111c597ab3bfefe831363fef0fcf26c567ea2ccae485e51b002fde
    steps:
      - checkout
      - run: wget https://github.com/google/google-java-format/releases/download/google-java-format-1.8/google-java-format-1.8-all-deps.jar
      - run: find . -name *.java | xargs java -jar google-java-format-1.8-all-deps.jar --dry-run --set-exit-if-changed
      - run:
          command: |
            echo "Run find . -name *.java | xargs java -jar google-java-format-1.8-all-deps.jar --replace
          when: on_fail
  check-shell:
    docker:
      # See https://circleci.com/docs/2.0/docker-image-tags.json for a list of images
      - image: cimg/base:2020.08@sha256:f19c30e3f8019f5c91fe14fc87c9f280293c5baef56f154e82d48fa5b1a21e86
    steps:
      - checkout
      - run: sudo apt-get update
      - run: sudo apt-get install shellcheck
      - run: shellcheck tools/start_solution
  check-python:
    docker:
      # See https://circleci.com/docs/2.0/docker-image-tags.json for a list of images
      - image: circleci/python:3.8.5@sha256:885c613a51b79d8343d2122f6f564c9c196e9f8ba315e75b0e93b62c068f74f3
    steps:
      - checkout
      - run: pip install pylint
      - run: find . -name *.py | xargs pylint --indent-string='  ' --disable=missing-docstring --disable=too-many-public-methods
  check-go:
    docker:
      # See https://circleci.com/docs/2.0/docker-image-tags.json for a list of images
      - image: circleci/golang:latest@sha256:f65c865a5cdb2c061daba6c513a92bd19841c3269b594c54961963b89a956b51
    steps:
      - checkout
      # C++ files confuse vet
      - run: find . -name *.cc | xargs rm
      - run: go vet ./...

workflows:
  test-workflow:
    jobs:
      - check-buildifier
      - check-cc
      - check-go
      - check-java
      - check-json
      - check-python
      - check-shell
      - check-typescript
      - test
